---
title: "Bias App"
author: # Grönwold, Palmer, Tilling
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r setup, include=FALSE}
require(flexdashboard)
require(shiny)
require(rmarkdown)
require(knitr)
library(DiagrammeR)
library(tidyverse)
library(plotly)
```

```{r, include=FALSE}
# functions for the biases
confounderbias <-
  function(x = 0.1,
           ratio = 1,
           varc = 1,
           sigma2x = 1,
           rho = NULL,
           vary = NULL) {
    if (is.null(rho)) {
      bcy <- x / ratio
      (x * bcy * varc) / (x ^ 2 * varc + sigma2x)
    } else {
      (rho * sqrt(vary)) / sqrt(varx)
    }
  }
```

# Confounding {data-height=800}

```{r}
# ui ----
  ui = fluidPage(
    withMathJax(),
      fluidRow(
        column(6,
      p(
        "In this model, shown in the path diagram on the right, we consider the effect of omitting a confounder, $C$, from the regression of $Y$ on $X$."),
        br(),
        p("The bias in the estimate of $\\beta_{xy}$ when we do not adjust for $C$ is given by: $$\\text{Bias} = \\frac{\\beta_{cx}\\beta_{cy}\\text{Var}(C)}{\\beta_{cx}^2\\text{Var}(C) + \\sigma_{X}^2}$$"),
        br(),
        p("The plot below visualises this bias. Change the settings to explore how the bias changes."
      )),
      column(6, grVizOutput("confdiagram", width = "250px"))
      ),
  fluidRow(column(12, plotlyOutput("plot1"))),
    fluidRow(
      column(2,
             numericInput("ratio", "Ratio: $\\beta_{cx} / \\beta_{cy}$", value = 1, step = 0.1, width = "100px")),
      column(2,
             numericInput("varc", "$\\text{Var}(C)$", value = 1, step = 0.1, width = "100px")),
      column(2,
             numericInput("sigma2x", "$\\sigma^2_{X}$", value = 1, step = 0.1, width = "100px")),
      column(2,
             numericInput("xmin", "X-axis min", value = -0.2, step = 0.1, width = "100px")),
      column(2,
             numericInput("xmax", "X-axis max", value = 0.2, step = 0.1, width = "100px"))
    )
  )
  
# server ----
  server = function(input, output) {

    output$confdiagram <- renderGrViz({
      grViz({"
      digraph dag {
      graph [rankdir=TB]
      node [shape=plaintext, width=0.3, height=0.3]
      X 
      C 
      Y
      node [shape=circle, height=0.3, fixedsize=true]
      Ex [label='&epsilon;@_{x}']
      Ey [label='&epsilon;@_{y}']
      { rank = same; X Y }
      X -> Y [minlen=3, label='&beta;@_{xy}']
      C -> X [label='&beta;@_{cx}']
      C -> Y [minlen=.5, label='&beta;@_{cy}']
      C -> C [dir='both', headport='n', tailport='n']
      Ex -> X [label='1']
      Ey -> Y [label='1']
      }
      "})
    })
    
    output$plot1 <- renderPlotly({

        ggplotly(
        ggplot(data = data.frame(x = 0), 
               mapping = aes(x = x)) + 
        stat_function(fun = confounderbias, 
                      colour = "blue",
                      args = list(varc = input$varc,
                                  sigma2x = input$sigma2x,
                                  ratio = input$ratio)) +
        scale_x_continuous(limits = c(input$xmin, input$xmax)) + 
        ylab("Bias") + 
        xlab("$\\beta_{cx}$")
      )
      
    })
    
  }

# Define as app ----
shinyApp(ui = ui, server = server)
```

# Colliding

```{r}
# ui ----
  ui = fluidPage(
    withMathJax(),
      fluidRow(
        column(6,
      p(
        "In this model, shown in the path diagram on the right, we consider the effect of including a collider, $C$, in the regression of $Y$ on $X$ and $C$."),
        br(),
        p("The bias in the estimate of $\\beta_{xy}$ when we adjust for $C$ is given by: $$\\text{Bias} = -\\frac{(\\beta_{xy}\\beta_{yc} + \\beta_{xc})(\\text{Var}(Y)- \\beta_{xy}^2\\text{Var}(X))\\beta_{yc}}{\\text{Var}(C) - \\text{Var}(X)(\\beta_{xy}\\beta_{yc} + \\beta_{xc})^2}$$"),
        br(),
        p("The plot below visualises this bias. Change the settings to explore how the bias changes."
      )),
      column(6, grVizOutput("confdiagram", width = "250px"))
      ),
  fluidRow(column(12, plotlyOutput("plot1"))),
    fluidRow(
      column(2,
             numericInput("ratio", "Ratio: $\\beta_{cx} / \\beta_{cy}$", value = 1, step = 0.1, width = "100px")),
      column(2,
             numericInput("varc", "$\\text{Var}(C)$", value = 1, step = 0.1, width = "100px")),
      column(2,
             numericInput("sigma2x", "$\\sigma^2_{X}$", value = 1, step = 0.1, width = "100px")),
      column(2,
             numericInput("xmin", "X-axis min", value = -0.2, step = 0.1, width = "100px")),
      column(2,
             numericInput("xmax", "X-axis max", value = 0.2, step = 0.1, width = "100px"))
    )
  )
  
# server ----
  server = function(input, output) {

    output$confdiagram <- renderGrViz({
      grViz({"
      digraph dag {
      graph [rankdir=TB, layout=neato]
      node [shape=box, height=0.4, width=0.4]
      X [pos='0,1!']
      C [pos='1,0!']
      Y [pos='2,1!']
      node [shape=circle, height=0.4, fixedsize=true]
      Ec [label='&epsilon;@_{C}', pos='1,-1!']
      { rank = same; X Y }
      X -> C [label='&beta;@_{xc}']
      Y -> C [minlen=.5, label='&beta;@_{yc}']
      X -> Y [label='&beta;@_{xy}']
      Ec -> C [label=1]
      X -> X [dir='both', headport='w']
      Y -> Y [dir='both', headport='e']
      }
      "})
    })
    
    output$plot1 <- renderPlotly({

        ggplotly(
        ggplot(data = data.frame(x = 0), 
               mapping = aes(x = x)) + 
        stat_function(fun = confounderbias, 
                      colour = "blue",
                      args = list(varc = input$varc,
                                  sigma2x = input$sigma2x,
                                  ratio = input$ratio)) +
        scale_x_continuous(limits = c(input$xmin, input$xmax)) + 
        ylab("Bias") + 
        xlab("$\\beta_{cx}$")
      )
      
    })
    
  }

# Define as app ----
shinyApp(ui = ui, server = server)
```

# About

Authors:

- Rolf Grönwold, Department of Clinical Epidemiology/Department of Medical Statistics, Leiden University Medical Centre, Leiden, Netherlands
- Tom Palmer, Department of Mathematics and Statistics, Lancaster University, Lancaster, UK
- Kate Tilling, MRC Integrative Epidemiology Unit at the University of Bristol, Bristol, UK

Please email, <tom.palmer@lancaster.ac.uk>, or see the GitHub repo with any questions or comments.